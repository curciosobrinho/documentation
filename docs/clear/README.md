# CLEAR Connector

Author: CLEAR

# Introduction

The CLEAR Web Verification technology solution offers a seamless way for partners to integrate with our products in order to verify a user's identity to unlock the desired experience.

There are three primary phases to a transaction when using CLEAR's Web Verification solution. These phases are:
1. Authentication - User verification and consent to share data
2. Token Service - Retrieval of OAuth and OIDC compliant tokens that establish the member identity
3. Data Sharing - Request for member data and the subsequent response payload

CLEAR's solution allows both new users and returning CLEAR users to easily verify their identity. The CLEAR Web Verification flow is designed to allow easy and secure mobile browser authentication and authorization to share user consented information with a partner. As part of our standard terms and conditions, CLEAR will always obtain express consent from a member whenever that member is preparing to share their personal information with one of CLEAR's partners for the first time

This connector is to perform above listed three phases by redirecting to CLEAR's Web Verification web app invoked via OpenID Connect (OIDC) and return back to the connector.

# Setup

## Requirements

To use the connector, you'll need:

* CLEAR PIE Environment
* Partner Onboard

CLEAR provides both a Partner Integration Environment (referenced as PIE, CLEAR's Sandbox) for development and a Production Environment.

In order for partners to integrate with CLEAR's Web Verification solution, the partner needs to first define the assurance rule(s) and the data elements required for the use case. At the time of onboarding, the partner needs to provide the redirectURI(s) where the user would be redirected to after exiting verification

**Assurance Rules**
Identity assurance is a measure/level of how strong the identity assertion is required for the use case.

**Data Elements**
Data elements are the member identity attributes such as first name, family name, age verification, address, etc. The user attributes that are shared after a successful verification, and are defined by the partner which may require security and legal approval depending on the requested elements

**RedirectURI**
Following the OAuth specification, after the user has completed authentication/verification, the user is directed to the redirectURI. This allows the user to continue downstream interactions after the verification

Once the assurance rules and data elements are defined, and redirectURI is provided by the partner, CLEAR can begin onboarding the partner into the Partner Integration Environment (PIE).

## Setting up the connector

In Davinci, add a **CLEAR** connection. For help, see [Adding a connection](https://docs.pingidentity.com/csh?context=davinci_adding_a_connection).

The partner is supplied with below connector settings as part of the PIE provisioning

### Connector settings

**Redirect URL**
The unique redirect uri is auto-generated by Davinci and assigned to this connector when it is created. It needs to be registered with CLEAR inside partner onboarding process. When the verification of user is completed, CLEAR will direct user to this location. This allows the user to continue downstream interactions after the verification. In addition, after a successful verification, an authorization code is generated and appended to the redirectURI by CLEAR.

**Client ID**
The unique public identifier of the partner application provided by CLEAR during the onboarding process.

**Client Secret**
The cryptographic secret provided to the partner application provided by CLEAR during the onboarding process.

**State**
A string value defined by the partner, the same value is returned as a parameter with the redirectURI allowing the partner to validate and identify the session.

**Scope**
Generated from creation of use case during partner onboarding. The list of data items to be returned to the partner through server-to-server exchange, this list is presented to the user in the consent screen. 

**Use Case**
Same as **Client ID**. This is a partner use-case that satisfy assurance level, data elements and the redirect uri requirements with CLEAR engagement.

**Response Type**
CLEAR provided. Default OAuth response_type is “code”.

**Token Endpoint**
A POST API call to CLEAR with the authorization code (After a user successfully verifies and consents to sharing data with a partner, CLEAR will generate an “Authorization Code” and pass it back to the partner via a callback URL or redirectURI of the connector) received by the connector in order to obtain an ID/Access/Refresh token

**Userinfo Endpoint**
A GET API call to CLEAR with the **API Key**, "**preferred_username**" (can be extracted from the ID/Access token; thereafter, it can be
included in the API call) and the **Access Token** in order to retrieve member attributes that were defined as part of the OAuth scope (during onboarding).

**API Key**
CLEAR provided. A backend API key used in retrieving member data from CLEAR

**Logout Endpoint**
A POST API call to CLEAR with the **Access Token** in order to invalidate user session held by CLEAR.

**Redirect to Partner URI**
The location of the page, partner wish the connector direct the user to when the verification **session** completes with failure.

# Using the connector in a flow

You can use CLEAR connector as starting point or create your own flows to satisfy your requirements. The following section shows a sample flow

## Verify user Identity and display data elements

Use this flow to initiate web verification and display the user data elements

1. Create a new connection by selecting CLEAR connector from the Connections menu. 
2. Fill all the properties provided by CLEAR and save. The Redirect URI should be auto generated by Davinci after save.
3. Share the Redirect URI with CLEAR to be configured in a partner use case.
4. Use this connector inside the Flow Studio.
5. Add a HTTP connector to CLEAR connector for All Triggers True. 
6. Use **Custom HTML Message** capability on HTTP Connector to display all the data elements like Given Name, Family Name, Address, Birthdate, Driving License and others returned by CLEAR Connector for a successful verification of user Identity.
7. Perform Save > Deploy > Try Flow to tes this flow.
 
# Capabilities

### Redirect to CLEAR 


Redirect user to CLEAR

#### URL `textField`


The Auth URL of the 3rd party service

#### Verify with CLEAR `button`

#### showPoweredBy `toggleSwitch`

#### skipButtonPress `toggleSwitch`

---


# Troubleshooting

The following resources can help you solve issues with the CLEAR connector.

* Verify that all of the following elements were defined correctly when you initially created and configured the connector:
  * Client ID
  * Client Secret
  * State
  * Scope
  * Use Case
  * Response Type
  * Token Endpoint
  * Userinfo Endpoint
  * API Key
  * Logout Endpoint
  * Redirect to Partner URI

## Common solutions

* For each connector in the flow, make sure that all of the mandatory inputs have been provided
* Use the Analytics feature to see where the flow stopped
* Select the Options icon, and turn on Show Node ID. This will make it easier to identify the source of inputs and outputs.

## Troubleshooting resources

### Audit
You can use the audit log to identify potential issues. For more information, see [Audit](https://docs.pingidentity.com/csh?context=p1_c_reporting).

### Testing capabilities
Testing your flows frequently is the key to making them work correctly. For more information, see [Getting Started with DaVinci](https://docs.pingidentity.com/csh?context=davinci_testing_early_and_often)
